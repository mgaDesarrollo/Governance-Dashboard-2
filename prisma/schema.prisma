generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                          String                       @id
  name                        String
  email                       String?
  image                       String?
  role                        UserRole                     @default(CORE_CONTRIBUTOR)
  createdAt                   DateTime                     @default(now())
  updatedAt                   DateTime                     @updatedAt
  walletAddress               String?
  status                      UserAvailabilityStatus?      @default(AVAILABLE)
  reputation                  Int                          @default(0)
  fullname                    String?                      @db.VarChar(255)
  skills                      String?
  country                     String?                      @db.VarChar(255)
  languages                   String?
  comments                    Comment[]
  consensusComments           ConsensusComment[]
  consensusVotes              ConsensusVote[]
  resolvedObjections          Objection[]
  professionalProfile         ProfessionalProfile?
  proposals                   Proposal[]
  createdQuarterlyReports     QuarterlyReport[]            @relation("CreatedQuarterlyReports")
  quarterlyReportComments     QuarterlyReportComment[]
  quarterlyReportParticipants QuarterlyReportParticipant[]
  socialLinks                 SocialLinks?
  votes                       Vote[]
  joinRequests                WorkGroupJoinRequest[]
  workGroups                  WorkGroupMember[]
  workgroups                  WorkGroup[]                  @relation("UserWorkgroups")
}

model ProfessionalProfile {
  id         String   @id @default(cuid())
  userId     String   @unique
  tagline    String?  @db.VarChar(255)
  bio        String?
  experience String?
  linkCv     String?  @db.VarChar(2048)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SocialLinks {
  id        String   @id @default(cuid())
  userId    String   @unique
  facebook  String?  @db.VarChar(2048)
  linkedin  String?  @db.VarChar(2048)
  github    String?  @db.VarChar(2048)
  x         String?  @db.VarChar(2048)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Proposal {
  id            String         @id @default(cuid())
  title         String
  description   String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  expiresAt     DateTime
  status        ProposalStatus @default(IN_REVIEW)
  positiveVotes Int            @default(0)
  negativeVotes Int            @default(0)
  abstainVotes  Int            @default(0)
  authorId      String
  workgroupId   String?
  comments      Comment[]
  author        User           @relation(fields: [authorId], references: [id])
  workgroup     WorkGroup?     @relation(fields: [workgroupId], references: [id])
  votes         Vote[]

  @@index([authorId])
  @@index([workgroupId])
}

model Vote {
  id         String   @id @default(cuid())
  type       VoteType
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  userId     String
  proposalId String
  proposal   Proposal @relation(fields: [proposalId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([userId, proposalId])
  @@index([userId])
  @@index([proposalId])
}

model Comment {
  id         String   @id @default(cuid())
  content    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  userId     String
  proposalId String
  proposal   Proposal @relation(fields: [proposalId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([userId, proposalId])
  @@index([userId])
  @@index([proposalId])
}

model WorkGroup {
  id                  String                 @id @default(uuid())
  name                String                 @unique
  type                String
  dateOfCreation      DateTime
  status              String
  missionStatement    String
  goalsAndFocus       String[]
  totalMembers        String
  roles               String[]
  memberDirectoryLink String
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  proposals           Proposal[]
  quarterlyReports    QuarterlyReport[]
  joinRequests        WorkGroupJoinRequest[]
  members             WorkGroupMember[]
  users               User[]                 @relation("UserWorkgroups")
}

model WorkGroupMember {
  id          String    @id @default(uuid())
  userId      String
  workGroupId String
  role        String
  joinedAt    DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id])
  workGroup   WorkGroup @relation(fields: [workGroupId], references: [id])
}

model WorkGroupJoinRequest {
  id          String    @id @default(uuid())
  userId      String
  workGroupId String
  status      String
  message     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id])
  workGroup   WorkGroup @relation(fields: [workGroupId], references: [id])
}

model QuarterlyReport {
  id                String                       @id @default(uuid())
  workGroupId       String
  year              Int
  quarter           String
  detail            String
  theoryOfChange    String
  plans             String
  createdById       String
  createdAt         DateTime                     @default(now())
  updatedAt         DateTime                     @updatedAt
  challenges        Json
  consensusStatus   ConsensusStatus              @default(PENDING)
  consensusComments ConsensusComment[]
  consensusVotes    ConsensusVote[]
  createdBy         User                         @relation("CreatedQuarterlyReports", fields: [createdById], references: [id])
  workGroup         WorkGroup                    @relation(fields: [workGroupId], references: [id])
  budgetItems       QuarterlyReportBudgetItem[]
  comments          QuarterlyReportComment[]
  participants      QuarterlyReportParticipant[]
  votingRounds      VotingRound[]
}

model QuarterlyReportParticipant {
  id                String          @id @default(uuid())
  quarterlyReportId String
  userId            String
  quarterlyReport   QuarterlyReport @relation(fields: [quarterlyReportId], references: [id])
  user              User            @relation(fields: [userId], references: [id])
}

model QuarterlyReportBudgetItem {
  id                String          @id @default(uuid())
  quarterlyReportId String
  name              String
  description       String
  amountUsd         Float
  quarterlyReport   QuarterlyReport @relation(fields: [quarterlyReportId], references: [id])
}

model QuarterlyReportComment {
  id                String          @id @default(uuid())
  quarterlyReportId String
  userId            String
  content           String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  quarterlyReport   QuarterlyReport @relation(fields: [quarterlyReportId], references: [id])
  user              User            @relation(fields: [userId], references: [id])

  @@unique([quarterlyReportId, userId])
}

model ConsensusVote {
  id        String            @id @default(uuid())
  userId    String
  reportId  String
  voteType  ConsensusVoteType
  comment   String
  roundId   String
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  report    QuarterlyReport   @relation(fields: [reportId], references: [id])
  round     VotingRound       @relation(fields: [roundId], references: [id])
  user      User              @relation(fields: [userId], references: [id])
  objection Objection?

  @@unique([userId, roundId])
  @@index([reportId])
  @@index([roundId])
}

model ConsensusComment {
  id              String             @id @default(uuid())
  userId          String
  reportId        String
  parentCommentId String?
  content         String
  likes           String[]
  dislikes        String[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  parentComment   ConsensusComment?  @relation("CommentReplies", fields: [parentCommentId], references: [id])
  replies         ConsensusComment[] @relation("CommentReplies")
  report          QuarterlyReport    @relation(fields: [reportId], references: [id])
  user            User               @relation(fields: [userId], references: [id])

  @@index([reportId])
  @@index([parentCommentId])
}

model Objection {
  id           String          @id @default(uuid())
  voteId       String          @unique
  status       ObjectionStatus @default(PENDIENTE)
  resolvedById String?
  resolvedAt   DateTime?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  resolvedBy   User?           @relation(fields: [resolvedById], references: [id])
  vote         ConsensusVote   @relation(fields: [voteId], references: [id])

  @@index([status])
}

model VotingRound {
  id          String            @id @default(uuid())
  reportId    String
  roundNumber Int
  status      VotingRoundStatus @default(ACTIVA)
  startedAt   DateTime          @default(now())
  endedAt     DateTime?
  votes       ConsensusVote[]
  report      QuarterlyReport   @relation(fields: [reportId], references: [id])

  @@unique([reportId, roundNumber])
  @@index([reportId])
  @@index([status])
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  CORE_CONTRIBUTOR
}

enum UserAvailabilityStatus {
  AVAILABLE
  BUSY
  VERY_BUSY
}

enum ProposalStatus {
  IN_REVIEW
  APPROVED
  REJECTED
  EXPIRED
}

enum VoteType {
  POSITIVE
  NEGATIVE
  ABSTAIN
}

enum ConsensusStatus {
  PENDING
  IN_CONSENSUS
  CONSENSED
}

enum ConsensusVoteType {
  A_FAVOR
  EN_CONTRA
  OBJETAR
  ABSTENERSE
}

enum ObjectionStatus {
  PENDIENTE
  VALIDA
  INVALIDA
}

enum VotingRoundStatus {
  ACTIVA
  CERRADA
  CONSENSADA
}
